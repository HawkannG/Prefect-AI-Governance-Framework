name: CodeQL Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 6am UTC
    - cron: '0 6 * * 1'

jobs:
  analyze:
    name: Analyze with CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        # Note: CodeQL has limited bash support, but can still catch some patterns
        # Primarily useful if the project adds other languages later
        languages: javascript
        queries: security-and-quality

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

    - name: Custom security checks
      run: |
        echo "Running custom security pattern checks..."

        # Check for hardcoded secrets patterns
        echo "Checking for potential secrets..."
        ! grep -rE '(password|secret|key|token)\s*=\s*["\x27][^"\x27]{8,}' .claude/hooks/ tests/ || {
          echo "WARNING: Potential hardcoded secrets found"
          exit 1
        }

        # Check for unsafe bash patterns
        echo "Checking for unsafe bash patterns..."
        ! grep -rE '\$\(.*\$.*\)' .claude/hooks/ || {
          echo "WARNING: Potentially unsafe command substitution nesting"
        }

        # Check for eval usage (dangerous)
        echo "Checking for eval usage..."
        ! grep -r 'eval ' .claude/hooks/ || {
          echo "ERROR: 'eval' usage detected - security risk!"
          exit 1
        }

        echo "âœ“ Custom security checks passed"
