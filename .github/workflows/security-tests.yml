name: Security Tests

on:
  push:
    branches: [ main, develop, 'security-*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  security-validation:
    name: Security Validation Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          jq --version

      - name: Verify hook scripts exist
        run: |
          ls -la .claude/hooks/
          echo "Hook scripts found:"
          ls .claude/hooks/*.sh

      - name: Make hooks executable
        run: chmod +x .claude/hooks/*.sh tests/security/*.sh

      - name: Run quick security validation
        run: |
          echo "ğŸ” Running security validation suite..."
          bash tests/security/quick-test.sh

      - name: Security validation passed
        if: success()
        run: |
          echo "âœ… All critical security tests passed!"
          echo "Framework is secure and ready for production use."

      - name: Security validation failed
        if: failure()
        run: |
          echo "âŒ Security tests failed!"
          echo "Critical vulnerabilities detected. Review test output above."
          exit 1

  comprehensive-tests:
    name: Comprehensive Security Tests
    runs-on: ubuntu-latest
    needs: security-validation  # Only run if quick tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          jq --version

      - name: Make test scripts executable
        run: chmod +x .claude/hooks/*.sh tests/security/*.sh

      - name: Run individual test suites
        run: |
          echo "Running comprehensive security test suite..."
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test 1: Symlink Attack Prevention (P2-V1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash tests/security/test-symlink-attack.sh || exit 1
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test 2: Path Traversal Prevention (P2-V2)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash tests/security/test-path-traversal.sh || exit 1
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test 3: Exit Code Correctness (P2-V4)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash tests/security/test-exit-codes.sh || exit 1
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Test 4: Command Injection Prevention (P2-V3)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash tests/security/test-command-injection.sh || true  # Allow warnings
          echo ""

      - name: All comprehensive tests passed
        if: success()
        run: |
          echo "âœ… Comprehensive security test suite completed successfully!"
          echo "All vulnerability mitigations validated."
